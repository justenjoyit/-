# 网络协议分层

| 5层协议 | 7层协议    | 作用                         | 协议                     | 其他                  |
| ------- | ---------- | ---------------------------- | ------------------------ | --------------------- |
| 应用层  | 应用层     | 为应用程序提供服务           | HTTP/HTTPS/FTP/SMTP/POP3 |                       |
| 应用层  | 表示层     | 数据格式转换，数据加密       |                          |                       |
| 应用层  | 会话层     | 建立，管理，维护会话         |                          |                       |
| 传输层  | 传输层     | 建立，管理和维护端到端的连接 | TCP/UDP                  | 差错控制/流量控制     |
| 网络层  | 网络层     | IP选址和路由选择             | IP/ARP/RARP              | 路由器                |
|         | 数据链路层 | 提供介质访问和链路管理       |                          | MAC/LLC子层，差错检测 |
|         | 物理层     | 物理                         |                          |                       |

## 一.  网络层

IP不是可靠的协议，这是说，IP协议没有提供一种数据未传达以后的处理机制

1.1 ARP工作原理：

1. 主机A的IP地址为192.168.1.1，MAC地址为0A-11-22-33-44-01；主机B的IP地址为192.168.1.2，MAC地址为0A-11-22-33-44-02；
2. 当主机A要与主机B通信时，地址解析协议可以将主机B的IP地址（192.168.1.2）解析成主机B的MAC地址，以下为工作流程：
   1. 第1步：根据主机A上的路由表内容，IP确定用于访问主机B的转发IP地址是192.168.1.2。然后A主机在自己的本地ARP缓存中检查主机B的匹配MAC地址。
   2. 第2步：如果主机A在ARP缓存中没有找到映射，它将询问192.168.1.2的硬件地址，从而将ARP请求帧广播到本地网络上的所有主机。源主机A的IP地址和MAC地址都包括在ARP请求中。本地网络上的每台主机都接收到ARP请求并且检查是否与自己的IP地址匹配。如果主机发现请求的IP地址与自己的IP地址不匹配，它将丢弃ARP请求。
   3. 第3步：主机B确定ARP请求中的IP地址与自己的IP地址匹配，则将主机A的IP地址和MAC地址[映射](https://baike.baidu.com/item/%E6%98%A0%E5%B0%84)添加到本地ARP缓存中。
   4. 第4步：主机B将包含其MAC地址的ARP回复消息直接发送回主机A。
   5. 第5步：当主机A收到从主机B发来的ARP回复消息时，会用主机B的IP和MAC地址映射更新ARP缓存。本机缓存是有生存期的，生存期结束后，将再次重复上面的过程。主机B的MAC地址一旦确定，主机A就能向主机B发送IP通信了。

1.2 IP划分

![ip划分](./images/ip划分.png)

计算：

网络号=IP地址&子網掩碼

主機號是從全0到全1的地址範圍

私有IP：

- 10.*，前8位是网络号，共16,777,216个地址
- 172.16.* 到172.31.*，前12位是网络号，共1,048,576个地址
- 192.168.*，前16位是网络号，共65,536个地址

1.3 ICMP重定向報文

当IP包在某一个地方转向的时候，都回给发送IP报的源主机一个ICMP重定向报文，而源主机就可以利用这个信息来更新自己的路由表。重定向報文只能由路由器發出。重定向報文爲主機所用，而不是爲路由器所用。